<!DOCTYPE html>
<html lang="en" class="h-100">

<head>

    <meta charset="utf-8">
    <link rel="icon" href="http://obj-cache.cloud.ruanbekker.com/favicon.ico">
    <!--<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
    <script src="https://cdn.plyr.io/3.7.3/plyr.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.3/plyr.css" />

    <title>Results</title>

</head>

<body>
    
    <br><br>
    <div class="container" style="margin-top: auto; margin-bottom: auto; padding-bottom: 15%"">
        <h1 align="center">

            <a href="/" style="text-decoration:none; color: #000;">PodMagic</a>
            
        </h1>
        <p align="center">Podcast search, with superpowers.</p>
        <br>
        <form class="d-flex" action="/search/results" method="post">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" name="input" autofocus>
            <button class="btn btn-outline-success" type="submit">Search</button>
        </form>

        <br>
        <center>
            <p style="text-align: center;"><b>You searched for:</b> "{{ input }}"</p>
        </center>
        <br> 
        <!-- if there are results -->
        {% if res['hits']['total']["value"] > 0 %}

            <!-- if chapter search -->
            {% if is_magic %}

                {% for hit in res['hits']['hits'] %}

                {% set url_audio = hit['_source']['audio_url'] %}
                {% set chapter_gist = hit['_source']['chapter_gist'].replace("'", "&#39;").replace('"', '&quot') %}
                {% set chapter_summary = hit['_source']['chapter_summary'].replace("'", "&#39;").replace('"', '&quot') %}
                {% set placeholder = "" %}
                

                <div class="card mb-3" style="max-width: 100%;">
                    <div class="row g-0 vertical-center">
                        <div class="col-sm-2 ">
                        <img src="{{ placeholder }}" class="img-fluid rounded" alt="artwork" style="max-width: 100%; vertical-align: middle;">
                        </div>
                        <div class="col-md-10">
                        <div class="card-body">
                            <h5 class="card-title">{{ chapter_gist }}</h5>
                            <p class="card-text">...{{ hit['highlight']['chapter_summary'][0][:200] if 'chapter_summary' in hit['highlight'] else hit['_source']['chapter_summary'][:200] |safe }}...</p>
                            <p class="card-text"><small class="text-muted">{{ placeholder }}</small></p>
                            <button onclick="update_url_source('{{ url_audio }}', '{{ chapter_gist }}')" class="btn btn-primary">Listen</button>
                            
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
                {% endfor %}
            {% else %}

                {% for hit in res['hits']['hits'] %}

                {% set url_audio = hit['_source']['episode_audio_link'] %}
                {% set podcast_title = hit['_source']['episode_title'].replace("'", "&#39;").replace('"', '&quot') %}
                {% set podcast_date = " ".join(hit['_source']['episode_pub_date'].split()[:4]) %}
                

                <div class="card mb-3" style="max-width: 100%;">
                    <div class="row g-0 vertical-center">
                        <div class="col-sm-2 ">
                        <img src="{{ hit['_source']['episode_artwork_link'] }}" class="img-fluid rounded" alt="artwork" style="max-width: 100%; vertical-align: middle;">
                        </div>
                        <div class="col-md-10">
                        <div class="card-body">
                            <h5 class="card-title">{{ hit['_source']['episode_title'] }}</h5>
                            <p class="card-text">...{{ hit['highlight']['episode_description_clean'][0][:200] if 'episode_description_clean' in hit['highlight'] else hit['_source']['episode_description_clean'][:200] |safe }}...</p>
                            <p class="card-text"><small class="text-muted">{{ podcast_date }}</small></p>
                            <button onclick="update_url_source('{{ url_audio }}', '{{ podcast_title }}')" class="btn btn-primary">Listen</button>
                            
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
                {% endfor %}
            {% endif %}
        {% else %}
            <p>No results found.</p>
        {% endif %}
        
        <br>
        <br>
        <br>
        

    </div>
    <div class="footer d-flex flex-column h-100" 
            style="position: fixed; left: 0; top: 85%;  z-index: 999999; width: 100%; height: 15%; background-color: #FFF; text-align: center; border-top: 1px solid #e5e5e5;">
        <center>
            <p style="margin-top: 10px; text-overflow: ellipsis; width: 90%; overflow: hidden; white-space: nowrap;"><span id="now_playing">No episode playing</span></p>
            <audio id="player">
                <source src="" type="audio/mpeg">
            </audio>
        </center>
    </div>
</body>


<script>
    const player = new Plyr('#player', {
        title: 'Now playing',
        global: false,
      });

    // update source
    function update_url_source(url, title) {
        player.source = {
            type: 'audio',
            title: title,
            sources: [{
                src: url,
                type: 'audio/mpeg',
            }],
        };
        player.play();
        // only the first 20 characters of the title
        document.getElementById("now_playing").innerHTML = "<b>Now playing:</b> " + title;
    }

  </script>

</html>